dovecot_config_version = 2.4.1
dovecot_storage_version = 2.4.1

# Authentication
auth_mechanisms = plain login
auth_username_format = %{user | username | lower}
auth_default_domain = {{ dovecot_domain }}

# Logging / runtime
base_dir = /var/run/dovecot
info_log_path = /var/log/dovecot.log
log_path = /var/log/dovecot.log
log_timestamp = "%Y-%m-%d %H:%M:%S "

# Users / mail
first_valid_uid = 5000
last_valid_uid  = 5000
first_valid_gid = 8
last_valid_gid  = 8
mail_access_groups = dovecot
mail_privileged_group = mail
# Default to no fsyncing (see https://wiki.dovecot.org/MailLocation/LocalDisk)
mail_fsync = never

# Mail storage settings (split from old mail_location syntax)
mail_driver = maildir
mail_path = /home/vmail/%{user | domain}/%{user | username}/Maildir
mail_index_path = /var/dovecot/indexes/%{user | domain}/%{user | username}

listen = 0.0.0.0

passdb pam {
}

userdb passwd {
  fields {
    uid  = vmail
    gid  = mail
    home = /home/vmail/%{user | domain}/%{user | username}
  }
}

protocols {
  imap = yes
}

# Services / listeners
service auth {
  process_limit = 1
  unix_listener /var/spool/postfix/private/auth {
    user = postfix
    group = postfix
    mode = 0660
  }

  unix_listener auth-master {
    user = vmail
    group = mail
    mode = 0660
  }

  user = dovecot
}

service anvil {
  unix_listener anvil-auth-penalty {
    user = dovecot
    group = dovecot
    mode = 0660
  }
}

service imap-login {
  executable = /usr/lib/dovecot/imap-login

  inet_listener imap {
    # disable non-SSL IMAP
    port = 0
  }

  inet_listener imaps {
    port = 993
  }

  process_limit = 32
}

service imap {
  executable = /usr/lib/dovecot/imap
}

service stats {
  unix_listener stats-writer {
    user = dovecot
    group = mail
    mode = 0660
  }

  unix_listener stats-reader {
    user = dovecot
    group = mail
    mode = 0660
  }
}

# TLS / SSL
ssl = required
ssl_server_ca_file = {{ dovecot_ssl_ca_file }}
ssl_server_cert_file = {{ dovecot_ssl_cert_file }}
ssl_server_key_file = {{ dovecot_ssl_key_file }}
ssl_min_protocol = TLSv1.3
ssl_cipher_list = TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK:!ADH:!LOW@STRENGTH
ssl_curve_list = X25519:X448

ssl_server_request_client_cert = no
auth_ssl_require_client_cert = no
auth_ssl_username_from_cert = no

# IMAP-specific
protocol imap {
  imap_max_line_length = 64k
  mail_max_userip_connections = 20
}

sieve_script global_before {
  type = before
  driver = file
  path = /etc/dovecot/sieve/
}

# Local delivery agent (LDA) / Sieve hooks
protocol lda {
  auth_socket_path = /var/run/dovecot/auth-master
  mail_plugins = sieve
  postmaster_address = postmaster@{{ dovecot_domain }}
  sendmail_path = /usr/lib/sendmail
  mail_fsync = optimized
}
