#!/bin/bash

set -x

# Parse arguments
RM_SNAPSHOTS=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --rm-snapshots)
            RM_SNAPSHOTS=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--rm-snapshots]"
            exit 1
            ;;
    esac
done

for pid in $(pgrep fstrim); do
    if [ $pid != $$ ]; then
        echo "[$(date)] : Process is already running with PID $pid"
        exit 1
    fi
done

{% if fstrim_filesystems %}
    {%- for fs in fstrim_filesystems.stdout_lines -%}
/sbin/fstrim -v {{ fs }}
    {% endfor -%}
{% endif %}
 
if [ -x /usr/bin/docker ]; then
    /usr/bin/docker image prune -af
else
    echo "docker does not appear to be installed, skipping image prune..."
fi

if [ -x /usr/bin/ctr ]; then
    /usr/bin/ctr -n k8s.io i rm $(/usr/bin/ctr -n k8s.io i ls -q)
elif [ -x /var/lib/rancher/rke2/bin/ctr ]; then
    CTR_CMD="/var/lib/rancher/rke2/bin/ctr --address /run/k3s/containerd/containerd.sock --namespace k8s.io"
    $CTR_CMD i rm $($CTR_CMD i ls -q)
    
    # Only remove snapshots if explicitly requested
    if [ "$RM_SNAPSHOTS" = true ]; then
        echo "WARNING: --rm-snapshots flag enabled. This may break running containers!"
        ALL_SNAPSHOTS=$($CTR_CMD snapshots list 2>/dev/null | awk 'NR>1 {print $1}')
        for snapshot in $ALL_SNAPSHOTS; do
            echo "Removing snapshot: $snapshot"
            $CTR_CMD snapshots remove "$snapshot" 2>/dev/null
        done
    else
        echo "Skipping snapshot removal (use --rm-snapshots to enable, but this is dangerous!)"
    fi
else
    echo "ctr does not appear to be installed, skipping image prune..."
fi

find /var/lib/rancher/rke2/agent/containerd -name "containerd-*.log.gz" -mtime +3 -delete 2>/dev/null || true
echo "Recover space completed successfully."
